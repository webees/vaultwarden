name: üßπ Clean GHCR SHA256 Images

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

permissions:
  packages: write
  contents: read

jobs:
  clean:
    runs-on: ubuntu-latest
    steps:
      - name: üßæ Delete SHA256-named GHCR images
        env:
          GH_TOKEN: ${{ github.token }}
          REPO_NAME: ${{ github.repository }}
          PACKAGE_NAME: adguard
        run: |
          echo "üîç REPO_NAME: $REPO_NAME"
          echo "üîç PACKAGE_NAME: $PACKAGE_NAME"

          echo "üîç Fetching all package versions for $PACKAGE_NAME..."
          VERSIONS_JSON=$(gh api -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            /user/packages/container/$PACKAGE_NAME/versions \
            --paginate)

          if [ -z "$VERSIONS_JSON" ]; then
            echo "‚ùå No versions found or API request failed."
            exit 1
          fi

          echo "üìú Raw versions JSON:"
          echo "$VERSIONS_JSON" | jq .

          VERSIONS=$(echo "$VERSIONS_JSON" | jq -r 'sort_by(.created_at) | reverse | .[] | select(.name | startswith("sha256:")) | .id')

          if [ -z "$VERSIONS" ]; then
            echo "‚úÖ No SHA256-named versions found."
            exit 0
          fi

          echo "üìã Found SHA256-named version IDs:"
          echo "$VERSIONS" | while read -r vid; do echo "  - $vid"; done

          for vid in $VERSIONS; do
            echo "üóëÔ∏è Attempting to delete version ID: $vid"
            if ! gh api -X DELETE \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GH_TOKEN" \
              /user/packages/container/$PACKAGE_NAME/versions/$vid 2> error.log; then
              if grep -q "You cannot delete the last tagged version" error.log; then
                echo "‚ö†Ô∏è Skipped version ID: $vid (last tagged version)"
              else
                echo "‚ùå Failed to delete version ID: $vid (unexpected error)"
                cat error.log
              fi
            else
              echo "‚úÖ Successfully deleted version ID: $vid"
            fi
          done
